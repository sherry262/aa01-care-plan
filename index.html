// Google Apps Script for AA01 Care Plan System
// 簡化版本 - 桃園市私立群和居家A單位

// ========== 設定區域 ==========
const SHEET_ID = 'YOUR_GOOGLE_SHEET_ID_HERE'; // 請替換為您的 Google Sheets ID
const SHEET_NAME = 'AA01資料';

// ========== 主要處理函式 ==========

/**
 * 處理 POST 請求
 */
function doPost(e) {
  try {
    // 解析請求
    const requestData = JSON.parse(e.postData.contents);
    const action = requestData.action;
    const data = requestData.data;
    
    let result;
    
    switch (action) {
      case 'save':
        result = saveToSheet(data);
        break;
      case 'test':
        result = { success: true, message: '連線測試成功' };
        break;
      default:
        result = { success: false, error: '不支援的操作' };
    }
    
    return createResponse(result);
    
  } catch (error) {
    console.error('處理請求失敗:', error);
    return createResponse({ success: false, error: error.toString() });
  }
}

/**
 * 處理 GET 請求（測試用）
 */
function doGet(e) {
  return createResponse({ 
    success: true, 
    message: 'AA01照顧計畫系統後端運作正常',
    timestamp: new Date().toISOString()
  });
}

/**
 * 儲存資料到 Google Sheets
 */
function saveToSheet(data) {
  try {
    const sheet = getOrCreateSheet();
    
    // 檢查是否已存在相同用戶的資料（根據用戶名稱和日期）
    const existingRowIndex = findExistingRow(sheet, data.userName, data.visitDate);
    
    const rowData = [
      new Date().toISOString(), // 時間戳記
      data.userName || '',      // 用戶姓名
      data.visitDate || '',     // 家訪日期
      data.dischargeDate || '', // 出院日期
      data.visitWith || '',     // 偕同訪視者
      data.physicalMental || '',// 身心概況
      data.economicIncome || '',// 經濟收入
      data.livingEnvironment || '', // 居住環境
      data.socialSupport || '', // 社會支持
      data.others || '',        // 其他
      data.reevaluation || '',  // 複評評值
      data.previousGoals || '', // 上次計畫目標
      data.currentGoals || '',  // 本次問題清單
      data.inconsistencyReason || '', // 不一致原因說明
      data.bCodeNotes || '',    // B碼服務（自動生成的備註）
      data.cCode || '',         // C碼服務
      data.dCodeNotes || '',    // D碼服務（自動生成的備註）
      data.efCodeNotes || '',   // EF碼服務（自動生成的備註）
      data.gCode || '',         // G碼服務
      data.scCode || '',        // SC碼
      data.mealService || '',   // 營養餐飲服務
      data.emergencyService || '', // 緊急救援服務
      data.referralServices || '', // 轉介其他服務資源
      data.caseManager || '',   // 個案管理員
      data.additionalNotes || '',  // 其他備註
      data.bCodeData || '',     // B碼原始資料（JSON格式）
      data.selectedDCodes || '', // D碼原始資料
      data.selectedEFCodes || '' // EF碼原始資料
    ];
    
    if (existingRowIndex > 0) {
      // 更新現有資料
      sheet.getRange(existingRowIndex, 1, 1, rowData.length).setValues([rowData]);
      console.log('資料已更新，行數:', existingRowIndex);
    } else {
      // 新增資料
      sheet.appendRow(rowData);
      console.log('新資料已新增');
    }
    
    return { 
      success: true, 
      message: '資料已儲存到 Google Sheets',
      action: existingRowIndex > 0 ? 'updated' : 'created',
      timestamp: new Date().toISOString()
    };
    
  } catch (error) {
    console.error('儲存失敗:', error);
    return { success: false, error: error.toString() };
  }
}

/**
 * 取得或建立工作表
 */
function getOrCreateSheet() {
  try {
    let spreadsheet;
    
    // 嘗試開啟現有試算表
    try {
      spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    } catch (error) {
      // 如果試算表不存在，建立新的
      spreadsheet = SpreadsheetApp.create('AA01照顧計畫資料庫');
      console.log('已建立新試算表，ID:', spreadsheet.getId());
      console.log('請將此ID更新到 SHEET_ID 變數中');
    }
    
    // 取得或建立工作表
    let sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      sheet = spreadsheet.insertSheet(SHEET_NAME);
      setupHeaders(sheet);
    }
    
    return sheet;
    
  } catch (error) {
    console.error('取得工作表失敗:', error);
    throw error;
  }
}

/**
 * 設定表格標題
 */
function setupHeaders(sheet) {
  const headers = [
    '時間戳記', '用戶姓名', '家訪日期', '出院日期', '偕同訪視者',
    '身心概況', '經濟收入', '居住環境', '社會支持', '其他', '複評評值',
    '上次計畫目標', '本次問題清單', '不一致原因說明', 
    'B碼服務', 'C碼服務', 'D碼服務', 'EF碼服務', 'G碼服務', 'SC碼', 
    '營養餐飲服務', '緊急救援服務', '轉介其他服務資源', '個案管理員', '其他備註',
    'B碼原始資料', 'D碼原始資料', 'EF碼原始資料'
  ];
  
  // 設定標題行
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // 格式化標題行
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setBackground('#4285f4');
  headerRange.setFontColor('#ffffff');
  headerRange.setFontWeight('bold');
  headerRange.setHorizontalAlignment('center');
  
  // 凍結標題行
  sheet.setFrozenRows(1);
  
  // 自動調整欄寬
  sheet.autoResizeColumns(1, headers.length);
  
  console.log('表格標題已設定');
}

/**
 * 尋找現有的資料行
 */
function findExistingRow(sheet, userName, visitDate) {
  try {
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) return 0; // 只有標題行
    
    // 尋找相同用戶和相同家訪日期的資料
    for (let i = 1; i < data.length; i++) {
      const rowUserName = data[i][1]; // 用戶姓名在第2欄
      const rowVisitDate = data[i][2]; // 家訪日期在第3欄
      
      if (rowUserName === userName && rowVisitDate === visitDate) {
        return i + 1; // 回傳行號（從1開始）
      }
    }
    
    return 0; // 沒找到
    
  } catch (error) {
    console.error('尋找現有資料失敗:', error);
    return 0;
  }
}

/**
 * 建立回應
 */
function createResponse(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}

// ========== 測試和維護函式 ==========

/**
 * 測試函式
 */
function testFunction() {
  console.log('開始測試...');
  
  // 測試工作表建立
  try {
    const sheet = getOrCreateSheet();
    console.log('✓ 工作表測試成功');
    console.log('工作表名稱:', sheet.getName());
    console.log('工作表ID:', sheet.getParent().getId());
  } catch (error) {
    console.log('✗ 工作表測試失敗:', error);
  }
  
  // 測試資料儲存
  const testData = {
    userName: '測試用戶',
    visitDate: '2025-01-20',
    caseManager: '測試管理員',
    physicalMental: '測試身心概況資料',
    bCodeNotes: 'BA01 × 5次、BA02',
    dCodeNotes: '世豪小客車租賃有限公司、福倫交通股份有限公司',
    efCodeNotes: 'EA01-1[馬桶增高器]、EB01[單支枴杖-不鏽鋼製]'
  };
  
  try {
    const result = saveToSheet(testData);
    console.log('✓ 資料儲存測試:', result);
  } catch (error) {
    console.log('✗ 資料儲存測試失敗:', error);
  }
  
  console.log('測試完成！');
}

/**
 * 取得統計資訊
 */
function getStatistics() {
  try {
    const sheet = getOrCreateSheet();
    const data = sheet.getDataRange().getValues();
    
    if (data.length <= 1) {
      return { totalRecords: 0, message: '沒有資料' };
    }
    
    const totalRecords = data.length - 1; // 扣除標題行
    const uniqueUsers = new Set();
    const today = new Date().toDateString();
    let todayRecords = 0;
    
    for (let i = 1; i < data.length; i++) {
      const userName = data[i][1];
      const recordDate = new Date(data[i][0]).toDateString();
      
      uniqueUsers.add(userName);
      
      if (recordDate === today) {
        todayRecords++;
      }
    }
    
    const stats = {
      totalRecords: totalRecords,
      uniqueUsers: uniqueUsers.size,
      todayRecords: todayRecords,
      lastUpdate: data[data.length - 1][0] // 最後一筆記錄的時間
    };
    
    console.log('統計資訊:', stats);
    return stats;
    
  } catch (error) {
    console.error('取得統計資訊失敗:', error);
    return { error: error.toString() };
  }
}
